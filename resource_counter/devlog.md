# 230404 v1.0
다시 1분정도 단축했고(여전히 느리지만 데이터를 받아오는게 아니라 인식하는거니까 별 수 없다), 난잡한 상수들을 좀 정리하고 설정하기 쉽게 만들어서 대충 v1으로 퉁치기로 했다.

내일은 친구들한테 테스트를 부탁해봐야겠다.

타깃 창 사이즈에 비례해서 동작하게끔 하려고 했는데 아직은 문제가 많다

1. 타깃 창의 크기가 바뀌면 불리는 이벤트 메서드는 루아 스크립트용이다. 파이썬 스크립트가 돌아가는 와중에 바로바로 호출시키기도 힘들고...
   - 일단은 무시하고 있는 상태다. 나중엔 바꿔야할지도 모르겠지만 큰 이슈는 아니라고 생각한다.
2. 화면비가 16:9가 아닐경우 블루아카이브에서는 레터박스를 적용하는데, 이 레터박스를 고려하지 않고 리사이징한다.
   - 아... 이거는 해결을 하려다가 아래 문제 생각나서 잠깐 홀딩이다.
3. 스크립트 내부의 다른 변수들은 다 적용한다 쳐도 원본 해상도에서 딴 이미지를 제대로 인식할지 알 수 없다
   - 그래서 사실상 당장 v1에서는 해상도를 1920*1080으로 고정해서 사용할 수 있다. 허허...
   - 다른 사이즈에서 어느정도 잘 되는지는 테스트해보는게 좋겠는데, 당장 해상도 바뀌면 IMax 쪽 커스텀 ROI들이 제대로 작동할지가 미지수다.
     - 안되면 이거 때려침

이제 대충 마무리하고 사용성개선, 버그수정만 한 뒤 끝낼까 한다.

1. 이전 데이터와 비교해서 변경치 보여주기, 여기서 threshold를 넘은 데이터는 파일 만들어서 경고 보여주기
2. 크레딧을 읽어올까 말까 고민중, 컴마(,) 들어간거라 인식률이 많이 구릴 수 있기 때문이다
3. 젤중요한 리드미
   - 원래는 영어로 적으려했는데, 영어를 그렇게 잘하지도 않는데다가 사실상 이거 한국어만 가능하게 만들어져있다.
     - AutoHotkey로 만들었으면 블루아카 서비스되는 언어들 tesseract trainedata 받아다가 인식시키고 오인식 PR만 받으면 되는데 ImageMax 종속적인 스크립트라 그건 힘들겠다.
     - 나중에 이거 참고해서 만들 사람 있으면 얼마든지 써도 된다고 사족만 달아두자
   - 사용방법을 얼마나 상세히 적어야할까?
     - 일단은 대충 적고 나중에 스크린샷 갖다 붙히자
4. `similar_items` 컬럼 지워야하는데 귀찮아서 방치중
   - 우선도는 낮다

# 230402 v0.91
속도개선을 위주로 작업했다. 결과 먼저 적자면 2배정도 향상(00:14:31 -> 00:07:09)
- 주로 오래걸리게 되는 이유는 BD 및 교본 오인식
- 또한 더이상 화면에 검사할 필요가 있는 아이템이 없는데도 계속해서 검사

이 두 가지의 문제를 해결하는건 쉽지 않을까 하고 아래의 시행착오를 겪었다:
1. 이게 맞거나 말거나 제일 먼저 찾아진 이미지를 돌려주는 것이 문제가 아닐까 하고 `ImageSearchMultipleResults()`를 사용함
   - 근데 1px단위로 같은걸 엄청나게 찾기도 하고, 비슷한 이미지도 대량으로 가져다준다
   - (x^2 + y^2) < stdDist^2 면 지우면 되는데 이것마저 귀찮아서 루아쪽에서 제곱도 안하고 대충 걸러줌
   - 사실 이게 귀찮았던 이유중 하나는 루아로 스크립트를 짜야한다는 점이다. `lua_get_value()`에서 리스트의 인덱스를 지정해서 받아오거나 프로퍼티를 지정해서 받아오거나 아니면 둘 다여서 안됐거나 아무튼 안 가져와져서 겹치는데이터를 잔뜩 가져온뒤 파이썬에서 걸러줘야하는데 너무...귀찮았다
   - 원래는 accuracy 정렬로 받아오려 했는데 루아에서 거르기 쉽게 포지션 정렬하고 파이썬에서 유사도정렬 시켜서 썼다..
   - 그다음 맨처음에 쓰려고했던 구조인 '아이템마다 roi테이블 셀크기로 만들어서 인식시키기'를 완전히 폐기하고 해당 목록을 돌게 했다.
   - 찾는 대상을 발견하면 그만 찾고 돌려주게, 찾는 도중에 덤으로 찾은건 한꺼번에 모아서 돌려주고
2. 이미지 서치를 호출하는 부분에서 가능하면 스킵을 하는 방향으로 수정했다
   - A를 찾다가 B, C를 실수로 찾는다면 걔네를 스킵목록에 넣고 검사를 하지 않게... 당연한건데 구조가 몇 번 수정되다가 이제야 넣었다.
   - 구조는 몇 번 바뀌었는데 정리는 비교적 적게 하니 헷갈리는 구문이 많아서 좀 수정했다.
3. 좀 야매식 최적화 진행했다.
   - 테이블에서 찾을 수 있는 마지막 아이템까지 찾은 뒤에도 다른 이미지가 있나 검사하느라 컴퓨팅 자원과 시간을 많이 사용했기 때문에
   - 지금 테이블에 표시된 마지막 좌표를 인식했고, 드래그한 줄 수만큼 인식을 진행했다면 그 다음 목록은 검사하지 않고 드래그 페이즈로 넘어간다.
   - 인식하지 않은 아이템을 인식했을 때 한 번 그 클릭 좌표값을 저장하고 오차범위를 줘서 같은 줄끼리 인식->드래그해서 갱신된 라인이 모두 채워졌고 마지막 셀이 우하단의 마지막 셀이라면 나머지를 스킵시키는 방식이다.
   - 테이블 자체의 컨텐츠 포지션을 아는 게 아니다보니 안 하려고 했던건데, 아이템 UI의 정렬 순서대로 `resources_data.json`을 정렬해두었기때문에 어느정도는 통용되리라 생각했다.
   - 몇개를 고의로 오인식되게 만들어 조건 테스트를 해봤을때는 안 검사한 셀이 있을 때는 안 넘어가는것을 확인했다(의도된 대로).
   - 만약에 여기서 더 간다면 한 칸 차이 안에 생략되는 인덱스가 있다면 그건 없는 것으로 간주시키는 방법이 있겠다.
   - 드래그 길이와 여러가지 매직넘버들을 세팅으로 뺄 필요가 있다.

이제부터 해야할 일은 다양한 환경에서 작동할 수 있게 매직넘버 상수들을 지우고 세팅값 혹은 env-relative한 값으로 바꿔주는 작업이다.
또한 편의기능으로 목록비교해서 크게 바뀌는 것들 목록을 뽑아주면 좋을 것 같은데... 그건 상수제거부터 하고 하자

# 230401 v0.9
아이템 이름 인식하고 도는것 잘되는것 확인함, 결과값을 빠르게 확인하기위해 디버그용 기능 몇개 추가.

다만 BD나 교본같은 비슷하게 생긴 이미지의 경우 오인식을 잔뜩 거치면서 맞는걸 찾기때문에 속도면에서는 문제가 생길 수밖에 없다...

장비 설계도 및 전용무기 강화재료 이미지노가다까지 끝냈고, 대충 테스트 돌려보니 오인식문제도 당장 imageMax 프로그램 단에서 해결이 될 것 같다.

export된 데이터에 덮어씌워서 플래너 사이트에 올렸을 때 제대로 들어가는것 확인했다.

당장 문제도 종종 `x245`가 `2245`가 되는 문제, 붉은겨울 일반BD가 인식이 안되는 문제 말고는 없다.

이제 앞으로 할 일은 아래와 같다:
1. 서치속도 개선
   1. 너무 많은 비슷한 이미지를 검사하기때문에 아주아주 오랫동안 한 페이지를 검사한다. 이걸 개선할 방법이 필요
   2. 이번 페이지에서의 실패목록을 추가한다면 어느정도의 성능 개선이 있을 것이다. 이 때문에 정확도가 떨어진다면 롤백해야할 것...
   3. roi 변경해가며 서치하는것도 생각해봤는데 기능이 가급적 단순했으면 좋겠어서 최후의 보루로 남겨두자
   4. `ImageSearchMultipleResults()` 사용을 고려해보는건 어떨까
2. 플래너 사이트에서 가져온 json 덮어씌우지 말고, 새 파일로 내보내기.
   1. 언제든 되돌릴 수 있어야 하니까...
3. 있으면 좋은 것들
   1. 이전 목록과 갯수를 비교해서 심하게 바뀐 목록을 알려주는 스크립트 작성 (n>50~100)
   2. 더 생각 안나네...

속도만 좀 개선되면 v1로 하고 올리자

# 230331 v0
전날에 술을 너무 많이먹어서 작업량이 많지는 않음

아이템 이름을 인식시키는 작업을 진행했다. 학교이름이 맞는지, BD/교본 등 아이템 타입이 맞는지 등을 검사를 추가만 하고 이에 따라 거르는 작업은 아직 하지 않았다. 그 이유는...:
1. lua 스크립트에서 cp949를 사용하고 있는 듯 하다. 루아에서 한글OCR을 한 데이터를 받아오려고 하면 디코드 에러가 난다.
2. 그래서 lua에도 utf8 인코딩 하는거 있겠지~ 하고 봤는데 너무 열악했고... 루아 스크립트를 가능한 적게 사용하고싶은 나로써는 base64 인코딩해서 파이썬 스크립트로 넘기는 방법을 선택했다.
3. 그래서 지금은 `lua:base64 encode`->`python:base64 decode(from cp949)`를 통해 한글 OCR 데이터를 받아오고 있다...

얼마 안 남았는데 하루종일 숙취가 심해서 작업일지도 더 못쓰겠다. 내일 마저 해야지...라고 썼다가 다시 하고싶어져서 좀 추가함

학교 이름과 아이템 타입, 등급을 비교해서 가장 맞는 아이템으로 인식시키도록 스크립트를 박살냈다. 이게 함수가 하는 역할이 반쯤씩 걸쳐져있는 기이한 구조가 되어버렸다. 하지만 제대로 카운팅만 된다면 일단 v1은 오케이가 아닐까 하는 생각을 하고있다.

당장 이렇게 바꾸고 나니 이건 '정확한 이미지를 검색해서 카운팅한다'라기보다는 'BD처럼 생겼으면 다 눌러서 이름보고 카운팅한다'가 되어버리지 않았나 싶지만... 제대로 동작하는걸 좀 먼저 보고싶다.

일단 인식용 이미지 바꾸고 유사도/설정 노가다했던것들을 되돌리니 속이 좀 시원하긴 하다. 내일은 교본까지 하고 나온 데이터를 잘 확인해봐야겠다.

+ 그러고보니 총력전 분포도 엑셀시트는 콜 쏴서 데이터 받아올텐데 그건 권한문제같은거가 안걸린건가? 만약 갖고있는 아이템 정보도 받아올 수 있다면 이 프로젝트 자체가 그냥 개고생의 일환이 되지 않을까 하는 불안함이 있다. 로그인에 포함된 데이터면 못 받아올 수 있어서 이 작업도 무용지물은 아니겠지만 말이다

# 230329 v0
인식문제를 너무 해결하기 싫어서 오늘은 리팩토링을 진행했다. 인식 프로세스의 중복코드를 제거하고 상수를 데이터화하고 json 읽어온것에서 문제되는것들을 수정하는 등을 했다.

이걸 먼저 한 이유는 해당 데이터 파일에서 `similar_items`가 비어있지 않으면 해당 아이템이 인식됐을 때 연쇄적으로 재검사를 하기 위함이다. 완벽한 인식이란건 없고 결과값 책임문제는 분산해야하니까... 기존에 작업했던 다른 것들과는 성격이 좀 다름을 감안하기로 했다.

아래는 다음에 할 일이다:

1. 먼저 BD들에 대해 추가 OCR 인식을 진행한다(아이템 이름)
   1. 클릭된 아이템과 다른 아이템일 경우 mismatched 목록에 추가한다.
   2. 이것을 위해 아이템 정보에 `학교이름`, `티어(최상급, 일반, ...)`, `아이템종류(BD, 교본, 오파츠)`를 추가한다.
   3. 헤당 힌트가 있는 아이템이라면 아이템 이름 OCR을 추가진행해서 키워드가 있는지 검사한다. (여기서도 OCR오인식 핸들링을 좀 해야한다)
   4. 힌트를 기반으로 어떤 아이템인지 판별한다.
2. 만약 판별된 아이템이 인식된 이미지와 다른 아이템이라면 인식데이터를 넘겨서 처리한다.
   1. 이 과정에서 오인식 로그를 파일로 남긴다.
   2. 해당 파일을 보고 `similar_items`를 구성한다.
3. `similar_items` 목록이 비어있지 않으면 해당 아이템을 검사시 연쇄검사를 진행한다.
   1. 연쇄적으로 이미지를 인식하고 유사도 데이터를 비교한다. 그 중 가장 높은 것으로 선택한다.
   2. 다만 이 경우에도 100% 신뢰가 어려우니 이름 OCR은 진행한다. 속도는 느려지겠지만 확실한 동작이 중요하다.
   3. 어느정도 데이터가 쌓여 오인식 패턴이 확인되면 `similar_items`만으로 검사하는것도 고려해본다.

플래너 사이트에 import 시킬 형식도 테스트해봐야하는데... 인식이 오차가 있으면 문제가 생기니까 일단 이게 먼저다.

과연 믿고 쓸 수 있을만큼 정확도가 높은 스크립트가 될 것인가... 아직은 모르겠다.

# 230328 v0
비슷한 이미지의 아이템들을 보고 이거 괜찮으려나...? 하는 생각을 했었는데 아니나다를까 문제가 좀 생겼다.
1. 기초/일반/상급/최상급 BD의 경우 외관 모양(테두리)이 전부 같은 모양이다. 거기서 색깔만 다르다.
2. 각 학교별 BD 또한 마크만 다르다.
3. 따라서 오인식률이 굉장히 높다. 92% 유사시에만 누르게 해도 다른학교 BD를 누르거나 하는데다가...
4. 색상별 인식률을 높이고자 명암체크옵션을 끄면 인식률이 처참해져 못 알아보는 문제가 생기고
5. 거기서 어떻게든 해보겠다고 인식률을 낮추면 다시 다른학원 BD들을 오인식해대기 시작한다

아마 교본에서 같은 문제가 있을거라 어떻게든 해결해야만 한다. 지금 생각나는 해결방법은 아래와 같다:
1. BD/교본 클릭시 아이템 이름을 한번 더 OCR인식해서 Validation을 진행한다.
   * 학교이름, 아이템 급수를 체크하고 해당 아이템으로 결과를 치환해준다.
   * 다만 OCR 오인식이 일어난다면? 진짜로 더이상 믿을 수 있는게 없다.
2. BD/교본 클릭시 좌측 클로즈업된 아이템 이미지와 블루아카이브 공식 리소스를 대조해서 체크한다
   * 이 또한 더블체크의 일환으로밖에 사용할 수 없다. 이 모든 문제가 비슷한 이미지들의 인식률에서 기인했기 때문이다.
   * 게다가 이 방법을 사용할 경우 투명도값이 있는 이미지를 가져와 edge비교를 해야하는데 과연 비슷하게생긴 BD들에서 오인식이 안 일어날지?
3. 가상의 테이블(5*4정도 칸)을 준비한다. 이미지 인식이 일어나면 그 자리의 위치를 기억해둔다.
   1. 스크롤 이벤트가 발생하기 전까지 같은 자리(가상의 테이블의 한 칸)에 대한 재인식을 허용하지 않는다.
   2. 스크롤 이벤트를 충분히 큰 값으로 설정한다(현재 2줄정도 스크롤, 그런데 이건 앱플레이어 터치입력에 따라 종종 작은 오차가 발생한다).
   3. 스크롤 이벤트가 발생하면 인식 저장목록을 초기화한다.
   * 다만 이 또한 주먹구구에, 애초부터 잘못된 이미지를 먼저 인식했다면 그대로 문제가 굳어진다.
4. 비슷한 이미지 목록 테이블을 만들어서, 해당 이미지가 hit 했을 경우 동일한 자리에 ROI를 생성해 가장 유사도가 높은 이미지를 선정한다.
   * 실행시간에 나쁜 영향을 준다.
   * 당장 스크립트 수정량은 가장 적다.
5. 아예 BD이미지를 널널한 인식률로 만들고 색상구분도 없애버린다. 그 뒤 모든 칸을 눌러서 OCR로만 아이템을 인식한다.
   * 이것 역시 해볼 법한 방법이기는 하나, OCR도 100%를 보장하지 않는다.
   * 따라서, 이미지 인식과 OCR 두개를 모두 진행하는게 그나마 제대로 된 인식률에 가까이 가는 방법이 아닐까 싶다.

위 목록에서 그나마 신뢰도가 어느 정도 있는 것을 고르라면 1, 4번이다. 두 개를 동시에 넣는것도 생각해봐야할 듯 싶다.

다만 스크립트 수정은 불가피해보인다. 애시당초 responsibility 영역에서 스크립트는 인식률을 의심하지 않는 방법으로 짜버린 나의 실책이다. 오인식이 발생할 수 있다는 사실을 예측하고 짰어야 했다.

일단 해둔것도 적자.
1. BD 이미지들을 다 따뒀다. 미인식/오인식으로 인해 몇 번씩 다시 땄는지 모르겠다. 일단은 다 따두긴 했는데 수정 중 어떻게 바뀔지는 알 수 없다.
2. 리소스 룩업에 오파츠를 추가했다. 오파츠 역시 비슷한 shape 이미지들의 인식 문제로 몇 차례 수정했다. 이건 그래도 모양이 좀 제각각이라 수월하게 인식이 됐는데, 이게 돼버려서 BD쪽도 될거라고 안일하게 생각한 것 같기도 하다.
3. 오파츠까지의 인식 후 프로세싱이 잘 되는 것을 확인했다. 다만 갯수 OCR이 특정 오파츠만 제대로 안 되고 말도안되는 높은 값이 들어가곤 하는 문제가 있는데, 이건 어떻게 풀어야 하려나?
   * 당장은 OCR 영역을 다시 잡아주니 되는 것 같긴 하던데... UI refresh rate를 좀 더 널널하게 잡아줘보고 안되면 사후처리 방향으로 가야겠다.
4. 스크롤&서치에 문제가 있는게 확인돼서 다시 좀 고쳤다. `update_state()`도 마음에 안 들어서 '기능이 잘 돌아가는 상태'가 되면 리팩토링하려고 했는데 당장은 요원해보인다.
5. 리소스목록 오파츠에 BD까지 넣으려니 너무 길고 귀찮아서 json형식으로 리소스리스트 만들어뒀다. csv쓰려했던건 데이터에 포함되는게 얼마 없어서였는데, 유사이미지 등의 정보를 넣으려면 확장성이 필요하겠다 싶었다.


내일은 BD문제만이라도 해결하길...

# 230327 v0
뭐든 예상시간을 생각하면 그것의 두배가 걸린다고 했던가? 오늘은 리소스 노가다 관련으로 많이했다. 근데 다는 안 끝났다.
1. 오파츠와 BD 이미지까지는 전부 땄다. 이걸 안하려고 UI리소스를 뜯어냈는데 인식이 잘 안돼서 결국 이거로 해야한다. 어제의 과제 3번은 망한 것이다.
   * 마지막 오파츠 이미지를 따다가 깨달은건데 인식률을 높이려고 아이템 칸 전체를 땄던게 더 인식률을 망치는 게 아닌가 하는 생각이 들었다.
   * 그도 그럴게 숫자가 이미지를 가리고 숫자는 항상 바뀌니까... 칸을 인식시킨다면 윗부분만 하거나 아이콘만 인식하는게 괜찮지 않나 하는 생각이다.
   * 애시당초에 프로그램에서도 작은 이미지를 권장한다(속도 때문에). 마지막 오파츠는 작게 땄는데 이것도 잘 인식한다...
2. 서드파티 리소스플래너 사이트에서 export 데이터 보고 id<->리소스 표 만들어뒀다. 이거 json이나 csv로 만들어서 동작하게 하면 될 것 같다. 물론 1번의 이미지작업이 끝나야 가능한 일이다.
3. 스크롤링을 추가했고, 별건아닌데 잘 카운트됐는지 콘솔창 보고있기 싫어서 파일로 저장시켰다
4. 당장 어제 생각했던 OCR방식을 적용했다. 일일이 클릭하는게 마음에 들지는 않으나 OCR동작면에서 훨씬 매끄러워졌다.
   * 다만 장비UI와 아이템UI에서 '사용하기'버튼의 유무로 인한 화면 구성 차이점때문에 OCR영역을 두 개 만들어야했기에 마음에 들지는 않았다.
     * 개발이야 원래 내맘대로 안되는 예외사항이 많고 스크립팅은 제약이 한단계 더 있는거니 별 수 없긴 하다.
5. formatter: 이건 그다지 신경쓸 필요 없을 듯 하다. 그냥 export된 데이터 보면 json형식이고 materials 키에 카운팅된것만 넣어주면 될 문제로 보인다. 

그리고 고민거리:
* 데이터컨테이너를 순회할땐 컨테이너의 카운트건 컨테이너가 제공하는 enumerator건 딱 있는 만큼 순회가 가능하지만 이렇게 UI를 보고 이미지서치를 해서 동작하는 매크로의 경우 그런 순회의 마지막 값이 무엇인지 알기 어렵다. 따라서 선택을 해야 한다:
  1. 스크롤이 끝났는지를 확인하는 절차 추가. 아무래도 확실하지 않다. 당장 제공되는 메서드로 이게 가능할지 알 수 없다.
  2. 특정 이미지를 찾을 때까지 끝내지 않음->엔딩 조건 이미지 인식시키기
     * 이 경우 유저마다 보유한 아이템이 다르며 해당 아이템은 사용하기조차 어렵게 되는데다 심하게 주먹구구식이라는 느낌이 들어서 피하고 싶다.
  3. 어떤 이미지도 찾지 못하는 상태가 N회 이상 반복되면 종료

아마 iii번으로 하지 싶지만 다른 괜찮은 방법이 있을지가 고민이다. 이런건 침대에서 생각해야한다.

* 인식률: BD나 스킬북은 같은 모양에 색깔만 바꾼게 많아서 인식률이 엉망이다. 일단 기준 인식률 95%를 넘겨야 되게 설정해두었으나, 여러가지 문제가 있다.
  * 아비도스 BD는 인식이 잘 안 된다. 어째서일까? 아비도스 BD를 검사할 때 엉뚱한 BD를 인식하길래 기준치를 바꾸고 색깔체크를 하게 해둬서일 것 같기도 하고... 기준치를 내려도 색깔체크 하는동안은 잘 인식을 못한다.
  * 다른 학교 BD도 문제가 있어서 꼼수 느낌으로 같은 학교 BD의 종류마다 다른 테두리를 포함하게 했더니 어느정도는 해소됐다. 엉뚱한걸 인식해서 잘못 카운트하는것만큼은 피하고싶다... 그렇게되면 이 스크립트를 작성한 모든 시간은 의미가 없다.
  * 현재 가장 문제인건 밀레니엄 색깔별로 구분 잘 안되는것(화면에 밀레니엄BD중 하나만 있다면 다 인식되는것), 아비도스 인식문제, 산해경 인식문제다.
  * OCR로 아이템 이름을 체크하는것도 생각해보았으나 거기서도 OCR 오차가 일어난다면? 정말로 지옥이 펼쳐진다.
  * 같은 자리에서 일정 거리이상 떨어지지 않은 자리에 인식 이벤트가 일어나면 무시하게 바꿔버리는 방법도 있다... 스크롤시 해당 목록 초기화하고...
* 하지만 당장 할 수 있는 일은 인식률을 높이기 위한 노가다뿐이라는 점이 슬프다
  * 최후의 최후에 사용하는 수단이라면 색깔체크 제거한 뒤 서치 히트했을때 색상을 뽑아오는 함수로 BD급수를 구분하는건데 이것만큼은 하고싶지 않다.

엄청난 노가다인데 당장 내일부터 총력전이랑 이벤트 시작이라 좀 미뤄질듯...

# 230326 v0
여러가지 문제가 많았다. 이 프로그램을 파이썬 프로젝트에서 패키지처럼 불러와 사용할 수 있으면 참 좋을텐데, 그런 방법은 없고 프로그램에 종속적으로 돌아가야한다. 프로그램이 가진 한계는 지금까지 파악한 바로는 이렇다:
1. 이미지(에셋)이 액션의 목록을 가지고, 스크립트를 실행하는 액션이라면 해당 타이밍에 불린 뒤 소멸한다.
   * 따라서 상태나 종합정보 등을 저장할 수는 없다. lua에 전역변수로 저장해둔다면 될 수도 있겠지만...
   * 이미지가 자원이 아닌 주체이기 때문에 구성이 좀 빡세다
2. OCR전용 이미지는 클릭이나 표시가 따로 안되며, 코드에서 ROI를 구성한걸 화면에 확인해서 디버깅하려해도 GUI에서 제공하는 영역표시 메서드를 스크립트에서는 사용할 방법이 없다.
3. python 스크립팅을 지원한대서 루아보다는 익숙하니 골랐는데, 루아를 지원하는 것에 비해 많이 부족하다. 제공하는 기초적인 메서드 `imax.lua()`, `imax.lua_get_value()`, `imax.lua_set_value()`만으로 해결은 가능하지만 코드퀄리티를 유지하거나 확장성있게 구성하기가 어렵다.
   * 따라서 lua 스크립트와 브릿지 역할을 해 주는 스크립트를 따로 작성해야 한다. 그런데...
   * 이미지가 자원이 아닌 리소스이며 스크립트가 매 액션마다 단일 execution인게 파이썬만 그런건지 루아도 그런건지 알 수 없다.
   * 일단은 IMax 개발자분께 문의는 드려보는데, 당장은 좀 더러운 코드를 짜겠다는 각오가 필요할 것 같다.

아마 이러한 문제는 내가 스탠드얼론 앱이 아닌 프로그램 내부에서 돌아가는 개별 스크립팅을 하는게 익숙치 않기 때문일 것이다..

당장 원하는 기능을 구현하기 위해 풀이한 것은 아래와 같다:
1. 액션만을 실행하는 단일 에셋을 추가하고 거기에 엔트리포인트 역할을 하는 스크립트를 추가했다. 여기에서 원래라면 이미지 에셋의 순서대로 구성했을 듯한 진행식을 작성한다.
2. 정말정말 하고싶지 않았지만 `importlib`를 통한 런타임 임포트를 추가해서 돌아가게 했다. Aㅏ...
   * 하지만 일단 나는 기능이 돌아가게 만드는게 첫번째라고 생각하는 사람이라 정리는 나중에 할 생각이다.
3. lua_helper 로 루아 스크립트에 직접 접근하는걸 일단 몰아뒀다. 어느 정도의 비즈니스로직이 침범하는건 당장은 감수해야 할 듯 하다.
4. 아주 대충 스테이트 구문을 만들어서 메인->옵션->아이템->뒤로->장비 순으로 순회하는걸 만들었다.
5. 첫 번째 페이지에서 스크롤 없이 인식 가능한 목록만을 데이터로 만든 뒤 확인해봤다. 일단은 ok인데 예외처리는 좀 필요할 듯 하다.

내일 바꿔보거나 추가구현할 목록은 아래와 같다:
1. OCR방식 바꾸기.
   * 지금은 테이블의 각 아이템에 적힌 숫자를 OCR로 인식해서 사용한다. 하지만 갯수가 많아지면 `123k`등으로 간략화되기도 하고, 아이템 이미지와 겹쳐서 존재하기때문에 인식률이 떨어질 때가 있다.
   * 따라서 각 아이템을 인식시 클릭하고 갯수가 적힌 UI에서 OCR을 진행하도록 바꿀 생각이다. 오히려 이 편이 더 편하기도 하다.
2. 드래그해서 이미지를 찾는 과정이 필요하다.
   * 이것 관련해서 고민인게, 아이템 하나를 찾을 때까지 드래그를 전부 해버리는건 너무 비효율적일 것 같고, 또 어떤 절충안을 쓰자니 버그가 생길 여지가 많다. 일단은 돌아가게 구현한 뒤 바꿔야 하는 것인가? 내일 이거 만들기 전까지만 새 방식을 생각해보자.
3. 이미지를 스크린샷이 아닌 원본으로 인식시킬 수 있는 방법이 없나 확인해보기
   * 리소스플래너 사이트에서 이미지를 긁어왔는데, IMax 프로그램에서 하나하나 이미지 긁어다가 인식시키는게 참 귀찮다는 생각이 들어서... 인식률이 망가진다면 별 수 없는데 이걸로 해결됐으면 좋겠다.
4. id formatter 만들기
   * 이걸 만들게 된 계기가 된 사이트에 등록시키려면 해당 사이트 양식에 맞게 포매팅할 필요가 있다.
   * export해서 현재 데이터를 받아온 뒤
   * 현재 이 프로그램에서 인식한 아이템들의 갯수로 치환시키고
   * 다시 해당 사이트에서 import 가능하게 한다
   * 이 과정은 굳이 IMax 위에서 전부 이뤄질 필요는 없다. 그냥 포매팅한 결과만 파일로 출력하면 된다. 이걸 익숙한 방법으로 하기 위해 lua가 아니라 python을 쓴 거기도 하고...
5. 리소스 룩업 데이터 텍스트파일로 뽑기
   * 코드에 데이터컨테이너로 존재하는게 아니라 csv나 json으로 뽑아두는게 여러모로 좋을 것 같다는 생각이다.
   * csv는 확장성이 별로지만 이 기능에서 확장성이 필요한가? 아닐 것 같아서 이쪽으로 마음이 기운다.

# 230325 v0
https://justin163.com/planner/ 이 사이트를 이용하다가 보유한 아이템을 자동으로 세어주면 좋겠다는 생각을 했다.

fiddler로 프록시를 열고 해당 프록시에 앱플레이어를 연결해보았으나 proxycap을 먹인 블루스택 등이 아니면 리퀘스트를 받아올 수 없는 문제를 발견했다.
차선책으로 공유기에 노트북과 안드로이드 폰을 연결하고 동일한 방법을 사용해볼까 했지만, 그렇게 엔드포인트를 따온다고 확실하게 쓸 수 있다는 보장도 없고(권한 문제 등), 매번 authToken 뜯어와서 PC에서 리퀘 날리기도 귀찮을 것 같아서 일단 해당 방법은 포기했다.

차선책은 클라이언트 사이드에서 긁어오는 것이었는데, 이것도 영 방법이 귀찮은 것 밖에 안보이는 와중에 이미지매크로를 돌리고 OCR로 카운팅을 하면 어떨까 하는 생각에 검색해보니 ImageMax라는 프로그램이 적당히 사용할만해보여 고르게 됐다.

### 필요한 동작
1. 실행시 톱니바퀴 클릭
2. '아이템' 버튼을 클릭해서 진입
   1. 갖고있는 보고서 카운팅
   2. 갖고있는 오파츠 카운팅
   3. 갖고있는 BD 카운팅
   4. 갖고있는 기술교본 카운팅
   5. 이 과정에서 드래그 사용, OCR로 숫자 인식
3. 뒤로가기로 이전 메뉴로 귀환
4. '장비' 버튼을 클릭해서 진입
   1. 갖고있는 경험치 아이템 카운팅
   2. 갖고있는 T2이상 설계도 갯수 카운팅
5. 퇴장
6. 카운팅된 아이템들을 리소스플래너 형식에 맞게 포매팅

### 해야할 일들
1. 인식할 이미지 표본 따기
2. 버튼 인식 과정 구현
3. UI 진입후 인식 활성/비활성 트리거링
4. 드래그하며 카운팅
5. 결과값 File I/O